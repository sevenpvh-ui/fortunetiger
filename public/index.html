<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Samurai Slot</title>
    <script src="https://pixijs.download/v7.x/pixi.min.js"></script>
    <style>
        body { 
            margin: 0; 
            background-color: #000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            width: 100vw;
            overflow: hidden;
            font-family: 'Courier New', monospace; 
        }
        
        #ui-layer {
            position: absolute;
            bottom: 30px;
            text-align: center;
            width: 100%;
            pointer-events: none;
            z-index: 10;
        }

        #spinBtn {
            pointer-events: auto;
            background: linear-gradient(45deg, #00ffcc, #0099ff);
            border: 2px solid #fff;
            padding: 20px 60px;
            font-size: 28px;
            font-weight: 900;
            color: #050510;
            cursor: pointer;
            box-shadow: 0 0 20px #00ffcc;
            border-radius: 50px;
            text-transform: uppercase;
            transition: transform 0.1s;
        }

        #spinBtn:active { transform: scale(0.95); }
        #spinBtn:disabled { background: #333; box-shadow: none; color: #777; border-color: #555; cursor: not-allowed; }

        #msg { 
            color: #fff; 
            font-size: 24px; 
            margin-bottom: 20px; 
            text-shadow: 0 0 10px #00ffcc; 
            background-color: rgba(0,0,0,0.8);
            display: inline-block;
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid #00ffcc;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="msg">PRESSIONE GIRAR</div>
        <br>
        <button id="spinBtn">GIRAR üó°Ô∏è</button>
    </div>

    <script>
        const app = new PIXI.Application({
            width: 800,
            height: 600,
            backgroundColor: 0x000000,
            resolution: window.devicePixelRatio || 1,
        });
        document.body.appendChild(app.view);

        function resize() {
            const ratio = Math.min(window.innerWidth / 800, window.innerHeight / 600);
            app.stage.scale.set(ratio);
            app.renderer.resize(800 * ratio, 600 * ratio);
            
            if(reelContainer) {
                const totalWidth = REEL_WIDTH * 3;
                const totalHeight = SYMBOL_SIZE * 3;
                reelContainer.x = (app.screen.width - (totalWidth * ratio)) / 2;
                reelContainer.y = (app.screen.height - (totalHeight * ratio)) / 2; 
            }
        }
        window.addEventListener('resize', resize);

        const REEL_WIDTH = 200;
        const SYMBOL_SIZE = 160; 
        const reels = [];
        const reelContainer = new PIXI.Container();
        
        let slotTextures = [];

        async function init() {
            try {
                const texturePromise = PIXI.Assets.load('assets/samurai.json');
                const bgPromise = PIXI.Assets.load('assets/background.png');
                
                const [sheet, bgTexture] = await Promise.all([texturePromise, bgPromise]);

                // Fundo da Cidade
                const background = new PIXI.Sprite(bgTexture);
                background.width = 800;
                background.height = 600;
                background.alpha = 0.4;
                app.stage.addChild(background);

                // Fundo Preto dos Rolos
                const slotBackground = new PIXI.Graphics();
                slotBackground.beginFill(0x000000, 0.6);
                slotBackground.drawRect(0, 0, REEL_WIDTH * 3, SYMBOL_SIZE * 3);
                slotBackground.endFill();
                
                // Borda Dourada (Para debug e est√©tica)
                slotBackground.lineStyle(4, 0xFFD700, 1); // Dourado
                slotBackground.drawRect(0, 0, REEL_WIDTH * 3, SYMBOL_SIZE * 3);

                reelContainer.addChild(slotBackground);
                app.stage.addChild(reelContainer);

                slotTextures = [
                    sheet.textures['samurai.png'], 
                    sheet.textures['robo.png'],
                    sheet.textures['espada.png'],
                    sheet.textures['moeda.png'],
                    sheet.textures['neon.png']
                ];

                createMachine();
                resize(); 
            } catch (error) {
                console.error("ERRO:", error);
                document.getElementById('msg').innerText = "ERRO: Verifique assets!";
            }
        }

        function createMachine() {
            // A M√ÅSCARA (Janela de Recorte)
            const mask = new PIXI.Graphics();
            mask.beginFill(0xffffff);
            mask.drawRect(0, 0, REEL_WIDTH * 3, SYMBOL_SIZE * 3);
            mask.endFill();
            
            reelContainer.mask = mask;
            reelContainer.addChild(mask);

            for (let i = 0; i < 3; i++) {
                const reelColumn = new PIXI.Container();
                reelColumn.x = i * REEL_WIDTH;
                reelContainer.addChild(reelColumn);

                const reel = {
                    container: reelColumn,
                    symbols: [],
                    blur: new PIXI.BlurFilter(),
                };
                
                reel.blur.blurX = 0;
                reel.blur.blurY = 0;
                reelColumn.filters = [reel.blur];

                for (let j = 0; j < 4; j++) {
                    const texture = slotTextures[Math.floor(Math.random() * slotTextures.length)];
                    const symbol = new PIXI.Sprite(texture);
                    
                    // --- CORRE√á√ÉO MATEM√ÅTICA AQUI ---
                    // Antes: symbol.y = j * SYMBOL_SIZE; (O topo ficava cortado)
                    // Agora: Somamos metade do tamanho (+ SYMBOL_SIZE / 2)
                    symbol.y = (j * SYMBOL_SIZE) + (SYMBOL_SIZE / 2);
                    
                    symbol.anchor.set(0.5); // Centro da imagem
                    symbol.x = REEL_WIDTH / 2;

                    // Ajuste de Escala (Margem de seguran√ßa de 20%)
                    const scaleX = (SYMBOL_SIZE * 0.8) / symbol.width; 
                    const scaleY = (SYMBOL_SIZE * 0.8) / symbol.height;
                    const finalScale = Math.min(scaleX, scaleY); 
                    symbol.scale.set(finalScale);

                    reelColumn.addChild(symbol);
                    reel.symbols.push(symbol);
                }
                reels.push(reel);
            }

            document.getElementById('spinBtn').addEventListener('click', startSpin);
        }

        async function startSpin() {
            const btn = document.getElementById('spinBtn');
            const msg = document.getElementById('msg');
            
            if (btn.disabled) return;
            
            btn.disabled = true;
            msg.innerText = "GIRANDO...";
            msg.style.color = "#00ffcc";

            reels.forEach(r => { r.blur.blurY = 20; });

            try {
                const response = await fetch('/spin', { method: 'POST' });
                const data = await response.json();

                const stopReel = (index) => {
                    setTimeout(() => {
                        const reel = reels[index];
                        reel.blur.blurY = 0;

                        const textureName = data.reels[index] + ".png"; 
                        const newTexture = PIXI.Assets.cache.get('assets/samurai.json').textures[textureName];

                        const targetSymbol = reel.symbols[1];
                        targetSymbol.texture = newTexture;
                        
                        // Reaplica escala na nova textura
                        targetSymbol.scale.set(1);
                        const scaleX = (SYMBOL_SIZE * 0.8) / targetSymbol.width;
                        const scaleY = (SYMBOL_SIZE * 0.8) / targetSymbol.height;
                        targetSymbol.scale.set(Math.min(scaleX, scaleY));

                        // Embaralha
                        reel.symbols[0].texture = slotTextures[Math.floor(Math.random() * slotTextures.length)];
                        reel.symbols[2].texture = slotTextures[Math.floor(Math.random() * slotTextures.length)];
                        [reel.symbols[0], reel.symbols[2]].forEach(s => {
                            s.scale.set(1);
                            const sx = (SYMBOL_SIZE * 0.8) / s.width;
                            const sy = (SYMBOL_SIZE * 0.8) / s.height;
                            s.scale.set(Math.min(sx, sy));
                        });

                        // Efeito de pulo
                        const startY = reel.container.y;
                        reel.container.y = startY + 30;
                        setTimeout(() => { reel.container.y = startY; }, 150);

                        if (index === 2) {
                            btn.disabled = false;
                            if (data.win) {
                                msg.innerText = `BIG WIN! ${data.multiplier}x`;
                                msg.style.color = "#ffcc00"; 
                            } else {
                                msg.innerText = "TENTE NOVAMENTE";
                                msg.style.color = "#fff";
                            }
                        }
                    }, index * 400 + 800);
                };

                stopReel(0);
                stopReel(1);
                stopReel(2);

            } catch (e) {
                console.error(e);
                msg.innerText = "ERRO DE REDE";
                btn.disabled = false;
                reels.forEach(r => { r.blur.blurY = 0; });
            }
        }

        init();
    </script>
</body>
</html>
